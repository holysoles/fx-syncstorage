{{- if (include "fx-syncstorage.autogenerateDbCredentials" .) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-db-urls
  labels:
    {{- include "fx-syncstorage.labels" . | nindent 4 }}
spec:
  template:
    spec:
      serviceAccountName: {{ include "fx-syncstorage.serviceAccountName" . }}
      restartPolicy: Never
      containers:
        - name: create-db-urls-secret
          image: bitnami/kubectl:latest
          env:
            - name: SECRET_NAME
              value: {{ printf "%s-db-urls" .Release.Name }}
            - name: TOKEN_DB_USER
              value: {{ .Values.tokenserverdb.auth.username }}
            - name: TOKEN_DB_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.tokenserverdb.auth.existingSecret }}
                  key: mysql-password
                  optional: false
            - name: TOKEN_DB_HOST
              value: {{ printf "%s-tokenserverdb" .Release.Name }}
            - name: TOKEN_DB
              value: {{ .Values.tokenserverdb.auth.database }}
            - name: SYNC_DB_USER
              value: {{ .Values.syncserverdb.auth.username }}
            - name: SYNC_DB_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.syncserverdb.auth.existingSecret }}
                  key: mysql-password
                  optional: false
            - name: SYNC_DB_HOST
              value: {{ printf "%s-syncserverdb" .Release.Name }}     
            - name: SYNC_DB
              value: {{ .Values.syncserverdb.auth.database }}
          command:
            - /bin/sh
            - -c
            - |+
              kubectl create -f - <<EOF
              ---
              apiVersion: v1
              kind: Secret
              metadata:
                name: $SECRET_NAME
                {{- if .Values.syncstorage.keepGeneratedSecrets -}}
                annotations:
                  helm.sh/resource-policy: keep
                {{- end }}
                labels:
                  {{- include "fx-syncstorage.labels" . | nindent 18 }}
              data:
                {{- if not .Values.syncstorage.syncserver.databaseUrl }}
                SYNC_SYNCSTORAGE__DATABASE_URL: $(echo -n "mysql://${SYNC_DB_USER}:${SYNC_DB_PASS}@${SYNC_DB_HOST}:3306/${SYNC_DB}" | base64 -w 0)
                {{- end }}
                {{- if not .Values.syncstorage.tokenserver.databaseUrl }}
                SYNC_TOKENSERVER__DATABASE_URL: $(echo -n "mysql://${TOKEN_DB_USER}:${TOKEN_DB_PASS}@${TOKEN_DB_HOST}:3306/${TOKEN_DB}" | base64 -w 0)
                {{- end }}
              EOF

{{- end }}

{{- if (include "fx-syncstorage.customDbUrls" .) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ printf "%s-db-existing-urls" .Release.Name }}
  labels:
    {{- include "fx-syncstorage.labels" . | nindent 4 }}
  {{- if .Values.syncstorage.keepGeneratedSecrets -}}
  annotations:
    helm.sh/resource-policy: keep
  {{- end }}
data:
  {{- if .Values.syncstorage.tokenserver.databaseUrl }}
  SYNC_TOKENSERVER__DATABASE_URL: {{ .Values.syncstorage.tokenserver.databaseUrl | b64enc | quote }}
  {{- end }}
  {{- if .Values.syncstorage.syncserver.databaseUrl }}
  SYNC_SYNCSTORAGE__DATABASE_URL: {{ .Values.syncstorage.syncserver.databaseUrl | b64enc | quote }}
  {{- end }}
{{- end }}
